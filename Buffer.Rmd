---
title: "Buffer"
author: "Jonathan Slaney"
date: "23/02/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Code for master's thesis buffer calculation 

## Required packages
```{r}
library(tidyverse)
library(lubridate)
library(ggplot2)
library(naniar)
library(ggmap)
library(ggthemes)
library(sf)
library(rgeos)
library(cancensus)
library(cowplot)
library(ggspatial)
library(knitr)
library(lmtest)
library(haven)
library(janitor)
library(pastecs)
library(psych)
library(car)
library(Hmisc)
library(ggm)
library(polycor)
library(tableone)
library(forcats)
library(gmodels)
library(QuantPsyc)
library(KernSmooth)
library(raster)
library(sp)
library(kableExtra)
```

## Game plan

1. SD participants
2. Simplify date
3. Summarize (makes results table of MVPA)
4. Figures
5. Visualize GPS points + bike infrastructure 2017/ 2019
6. Apply 70m buffer -> st_buffer()
7. Convert buffer file to sf.dataframe
8. Run st_intersect for buffer vs participant gps data

# Filter SD Participants
```{r}
## Reading in SD data
SD_vic_one <- read_csv("/Users/dfuller/Documents/INTERACT/data/sensors/victoria_01_top_1min_2020-01-10_sd.csv") # read in SD w1 participants n = 129
SD_vic_one <- SD_vic_one %>% mutate(sensedoc = "1") # Add variable to SD w1 (1)
SD_vic_two <- read_csv("/Users/dfuller/Documents/INTERACT/data/sensors/victoria_02_top_1min_2020-06-13_sd.csv") # read in SD w2 participants n = 153
SD_vic_two <- SD_vic_two %>% mutate(sensedoc = "2") # Add variable to victoria health w1 (1)
SD_vic_all <- bind_rows(SD_vic_one, SD_vic_two)

tabyl(SD_vic_all, interact_id, wave_id)
```
## Some basic cleaning

```{r warning=FALSE}
# Filter out if they are not in the city, Reason: No CTUID for out of the city
SD_vic_all <- SD_vic_all %>% filter(in_city == 1 & wearing == 1)

SD_vic_all <- SD_vic_all %>%
	mutate(activity_levels = case_when(
		x_count < 100 ~ "sedentary",
		x_count >= 100 & x_count <= 1951 ~ "light",
		x_count >= 1951 & x_count <= 5724 ~ "moderate",
	  x_count >= 5725 ~ "vigorous"
	))

sd_data <- SD_vic_all

rm(SD_vic_all)
rm(SD_vic_one)
rm(SD_vic_two)
```

## Create a date column and add a minutes in census tract by id, date, and census tract column

```{r}
#### SenseDoc
table(sd_data$wave_id)
sd_data$date <- sd_data$utcdate %>% as.Date()
sd_data$minutes <- 1
sd_data <- sd_data %>% 
  group_by(interact_id, date, wave_id) %>% 
  mutate(
      minutes_id_date = sum(minutes)
  )
```

### MPVA Minutes SenseDoc

```{r}
table(sd_data$activity_levels)
table(sd_data$wearing)
### MVPA Minutes
sd_data <- sd_data %>%
	mutate(mvpa = case_when(
		activity_levels == "light" ~ 0,
		activity_levels == "sedentary" ~ 0,
		activity_levels == "moderate" ~ 1,
		activity_levels == "vigorous" ~ 1
	))
### Sed Minutes
sd_data <- sd_data %>%
	mutate(sed = case_when(
		activity_levels == "light" ~ 0,
		activity_levels == "sedentary" ~ 1,
		activity_levels == "moderate" ~ 0,
		activity_levels == "vigorous" ~ 0
	))
### Sed Minutes
sd_data <- sd_data %>%
	mutate(light_pa = case_when(
		activity_levels == "light" ~ 1,
		activity_levels == "sedentary" ~ 0,
		activity_levels == "moderate" ~ 0,
		activity_levels == "vigorous" ~ 0
	))
sd_data <- sd_data %>% 
    group_by(interact_id, date) %>% 
      mutate(
        total_mvpa_minutes = sum(mvpa),
        total_sed_minutes = sum(sed),
        total_light_pa_minutes = sum(light_pa)
        )
sd_pa_table <- sd_data %>%
                group_by(interact_id, date, wave_id) %>%
                  summarise(
                    time = mean(minutes_id_date, na.rm = TRUE),
                    wearing = mean(wearing, na.rm = TRUE),
                    mean_mpva_sd = mean(total_mvpa_minutes, na.rm = TRUE), 
                    sd_mpva_sd = sd(total_mvpa_minutes, na.rm = TRUE), 
                    mean_sed_sd = mean(total_sed_minutes, na.rm = TRUE), 
                    sd_sed_sd = sd(total_sed_minutes, na.rm = TRUE), 
                    mean_light_sd = mean(total_light_pa_minutes, na.rm = TRUE), 
                    sd_light_sd = sd(total_light_pa_minutes, na.rm = TRUE), 
                    na_count = sum(is.na(total_mvpa_minutes)), 
                    count = n()
                  )
sd_pa_table
sd_sum_table <- sd_pa_table %>%
                group_by(wave_id) %>%
                  summarise(
                    time = mean(time, na.rm = TRUE), 
                    wearing = mean(wearing, na.rm = TRUE), 
                    mean_mpva_sd = mean(mean_mpva_sd, na.rm = TRUE), 
                    mean_sed_sd = mean(mean_sed_sd, na.rm = TRUE), 
                    mean_light_sd = mean(mean_light_sd, na.rm = TRUE), 
                    na_count = sum(is.na(time)), 
                    count = n()
                  )
sd_sum_table
```

### SD Activity Figures by wave

```{r}
##  formula = y ~ s(x, bs = "cs") with method = "REML".
wave1_activity <-  sd_pa_table %>% 
              filter(wave_id == "1") %>% 
              ggplot() + 
                    geom_smooth(aes(x = date, y = mean_light_sd), colour = "black", linetype = "dashed") +
                    geom_smooth(aes(x = date, y = mean_mpva_sd), colour = "grey") + 
                    geom_smooth(aes(x = date, y = mean_sed_sd),  colour = "black") +    
                  scale_x_date(date_breaks = "1 month", date_labels = "%m-%Y") +
                  ylim(0, 400) +
                  labs(x = "Date", y = "Minutes") +
                  theme_classic()
plot(wave1_activity)
ggsave("wave1_activity.jpg", dpi = 150, height = 4, width = 6)
```

```{r}
##  formula = y ~ s(x, bs = "cs") with method = "REML".
wave2_activity <-  sd_pa_table %>% 
              filter(wave_id == "2") %>% 
              ggplot() + 
                    geom_smooth(aes(x = date, y = mean_light_sd), colour = "black", linetype = "dashed") +
                    geom_smooth(aes(x = date, y = mean_mpva_sd), colour = "grey") + 
                    geom_smooth(aes(x = date, y = mean_sed_sd),  colour = "black") +    
                  scale_x_date(date_breaks = "1 month", date_labels = "%m-%Y") +
                  ylim(0, 400) +
                  labs(x = "Date", y = "Minutes") +
                  theme_classic()
plot(wave2_activity)
ggsave("wave2_activity.jpg", dpi = 150, height = 4, width = 6)
```

```{r}
victoria_activity <-  sd_pa_table %>% 
          ggplot() + 
                    geom_smooth(aes(x = date, y = mean_light_sd), colour = "black", linetype = "dashed") +
                    geom_smooth(aes(x = date, y = mean_mpva_sd), colour = "grey") + 
                    geom_smooth(aes(x = date, y = mean_sed_sd), colour = "black") +     
                scale_x_date(date_breaks = "1 month", date_labels = "%m-%Y") +
                ylim(0, 400) +
                labs(x = "Date", y = "Minutes") +
                theme_classic()
plot(victoria_activity)
ggsave("victoria_activity.jpg", dpi = 150, height = 4, width = 6)
```

# Apply 70m buffer to Pandora bike lane

# Read in 2017 Shape file

```{r}
getwd()
#Note to self all file formats must be in same directory (I think it's .shp and .shx that really matter)
vic_int <- st_read("/Users/dfuller/Documents/INTERACT/data/intervention/victoria/IBIMS_2017.shp")
```

# PLot Vic 2017 shp 
```{r}
st_crs(vic_int)
vic_int_t <- st_transform(vic_int, crs = 4326, "+proj=longlat +ellps=WGS84 +datum=WGS84")
st_crs(vic_int_t)
vic_int_t
vic_int_t$AAA <- vic_int_t$AAA %>% replace_na(0)
vic_int_plot <- ggplot() + 
                  scale_fill_gradient2(name="Count of GPS points", low="lightblue", high = "darkblue") +
                  geom_sf(data = vic_int_t, aes(colour = AAA)) +
                  coord_sf(
                      xlim = sf::st_bbox(vic_int_t)[c(1,3)],
                      ylim = sf::st_bbox(vic_int_t)[c(2,4)]) + 
                  scale_color_manual(name="Cycling Infrastructure", labels=c("Existing", "AAA"), values=c("grey80", "black")) +
                  annotation_scale() + 
                  theme_map()
plot(vic_int_plot)
ggsave("vic_int_plot.jpg", dpi = 150, height = 4, width = 6)
```

# Apply st_buffer() to vic 2017 shp
# Try: 
1. Filter for Victoria # I was stuck on using subset() which wouldn't work for the buffer. 
2. Filter for pandora
3. Apply 70m buffer
4. Convert pandora_buffer to sf.dataframe (geometry)
5. Check to make sure GPS data (from sd_vic_all) is in lat/long

```{r}
table(vic_int_t$AAA)
pandora <- filter(vic_int_t, AAA == "V")

# convert pandora to sf
pandora <- st_transform(pandora, 26910)
# apply 70m buffer
pandora_buffer = st_buffer(pandora$geometry, dist = 70) # According to stack exchangers the distance is in meters
plot(pandora_buffer)
```

# GET INTERSECTIONS
1. Convert pandora_buffer to buf using st.transform (to go from list to geometry)
2. Convert sd_data to sf.dataframe using convery sf
3. Run intersection on buf and sd_data
4. When I get that working, repeat for all 4 bike lanes.

# Convert sd_data lat/long to polygon using st_as_sf

```{r}
sd_data_sf <- st_as_sf(sd_data, coords = c("lon", "lat"), crs = 4326)
```

# Run intersections code for bike_lanes_1 (pandora) and gps participants

```{r}
pandora_buffer <- st_transform(pandora_buffer, 4326)
pandora_buffer <- st_as_sf(pandora_buffer)

sd_data_sf$exposed <- ifelse(sf::st_intersects(sd_data_sf, pandora_buffer, sparse = F), "Yes", "No")

table(sd_data_sf$exposed)
sd_data$exposed <- as.factor(sd_data_sf$exposed)

ggplot() + 
        geom_sf() +
        geom_sf(data = pandora_buffer) +                
        geom_point(aes(x = lon, y = lat, colour = exposed), data = sd_data, alpha = 0.2) +
        geom_sf(data = vic_int_t) +
        annotation_scale() + 
        theme_map()
ggsave("exposed_2017.jpg", dpi = 150, height = 4, width = 6)
```

# Read in 2019 Shape file

```{r}
vic_int_2019 <- st_read("/Users/dfuller/Documents/INTERACT/data/intervention/victoria/IBIMS_2019.shp")
st_crs(vic_int_2019)
```

# Plot Vic 2019 shp 
```{r}
vic_int_t2 <- st_transform(vic_int_2019, "+proj=longlat +ellps=WGS84 +datum=WGS84")
st_crs(vic_int_t2)
vic_int_t2

vic_int_t2$Notes <- vic_int_t2$Notes %>% replace_na(0)
vic_int_t2$AAA <- if_else(vic_int_t2$Notes == 0, 0, 1)
vic_int_t2$AAA <- as.factor(vic_int_t2$AAA)

vic_int_plot_2 <- ggplot() + 
                  #scale_fill_gradient2(name="Count of GPS points", low="lightblue", high = "darkblue") +
                  geom_sf(data = vic_int_t2, aes(colour = AAA)) +
                  coord_sf(
                      xlim = sf::st_bbox(vic_int_t2)[c(1,3)],
                      ylim = sf::st_bbox(vic_int_t2)[c(2,4)]) + 
                  scale_color_manual(name="Cycling Infrastructure", labels=c("Existing", "AAA"), values=c("grey80", "black")) +
                  annotation_scale() + 
                  theme_map()
plot(vic_int_plot_2)
ggsave("vic_int_plot_2.jpg", dpi = 150, height = 4, width = 6)
```

# Interventions SenseDoc Data

### Victoria

Apply 70m Buffer to 2019 data

```{r}
w2_intervention <- filter(vic_int_t2, AAA == 1)

w2_intervention <- st_polygonize(w2_intervention)

# convert pandora to sf
w2_intervention <- st_transform(w2_intervention, 26910)

# apply 70m buffer
w2_intervention_buffer = st_buffer(w2_intervention$geometry, dist = 200) # According to stack exchangers the distance is in meters
plot(w2_intervention_buffer)
```










```{r}

vic_cma <- get_census(dataset='CA16', regions=list(CMA="59935"),
                          level='CMA', use_cache = TRUE, geo_format = "sf")
vic_sd <- sd_data %>% filter(in_city == 1) 
sd_vic_days <- as.data.frame(unique(vic_sd$date))
vic_int <- st_read("/Users/jslan/Documents/INTERACT/data/intervention/victoria/IBIMS_2017.shp")
st_crs(vic_int)
vic_int_t <- st_transform(vic_int, crs = 4326, "+proj=longlat +ellps=WGS84 +datum=WGS84")
st_crs(vic_int_t)
vic_int_t
vic_int_t$AAA <- vic_int_t$AAA %>% replace_na(0)
vic_int_plot <- ggplot() + 
                  geom_sf(data = vic_cma) +
                  geom_hex(aes(x = lon, y = lat), binwidth = c(0.005, 0.005), data = vic_sd, alpha = 0.8) +
                  scale_fill_gradient2(name="Count of GPS points", low="lightblue", high = "darkblue") +
                  geom_sf(data = vic_int_t, aes(colour = AAA)) +
                  coord_sf(
                      xlim = sf::st_bbox(vic_int_t)[c(1,3)],
                      ylim = sf::st_bbox(vic_int_t)[c(2,4)]) + 
                  scale_color_manual(name="Cycling Infrastructure", labels=c("Existing", "AAA"), values=c("grey80", "black")) +
                  annotation_scale() + 
                  theme_map()
plot(vic_int_plot)
ggsave("vic_int_plot.jpg", dpi = 150, height = 4, width = 6)
```

# 

# GPS Maps

### Victoria

```{r}
### Full View
vic_basemap <- get_map(c(-123.5, 48.5),
                     source = "google",
                     maptype = "roadmap", crop = FALSE,
                     zoom = 10)
plot(vic_basemap)
vic_points <- ggmap(vic_basemap) + 
                  geom_bin2d(aes(x = lon, y = lat), binwidth = c(0.015, 0.015), data = vic_sd, alpha = 1) +
                  scale_fill_gradient2(low="darkred", high = "darkblue") +
                  theme_map()
plot(vic_points)
ggsave("vic_points.jpg", dpi = 150, height = 4, width = 6)
### Zoom 
vic_basemap_zoom <- get_map(location = "Victoria, BC, Canada",
                     source = "google",
                     maptype = "roadmap", crop = FALSE,
                     zoom = 13)
plot(vic_basemap_zoom)
vic_points_zoom <- ggmap(vic_basemap_zoom) + 
                  geom_bin2d(aes(x = lon, y = lat), binwidth = c(0.0025, 0.0025), data = vic_sd, alpha = 0.8) +
                  scale_fill_gradient2(high = "darkblue") +
                  theme_map()
plot(vic_points_zoom)
ggsave("vic_points_zoom.jpg", dpi = 150, height = 4, width = 6)
``` 

# Participant Data Flow

## Victoria

```{r}
## Veritas data VIC
veritas_vic <- read_csv("/Users/dfuller/Documents/INTERACT/data/veritas/veritas_1vic_main_1884baf.csv")
veritas_vic$veritas <- 1
### Health data 
data_small$health <- 1 
data_vic <- data_small %>%
              filter(city_id == "Victoria") %>%
              select(interact_id, city_id, health) 
length(data_vic$health) ### Number of Health Participants
flow_vic <- left_join(data_vic, veritas_vic)
table(flow_vic$veritas) ### Number of VERITAS Participants
### SenseDoc
vic_sd_small <- vic_sd %>%
                  group_by(interact_id) %>%
                  summarize(
                    interact_id = first(interact_id),
                    sensedoc = 1, 
                  )
flow_vic <- left_join(flow_vic, vic_sd_small)
table(flow_vic$sensedoc)  ### Number of SenseDoc Participants